#!/usr/bin/env bash

# --- volume helpers ---
get_volume(){
    pamixer --get-volume-human
}

volume_up(){
    pamixer --allow-boost --set-limit 150 -i 5
}

volume_down(){
    pamixer --allow-boost --set-limit 150 -d 5
}

toggle_mute(){
    pamixer --toggle-mute
}

# --- mako/libnotify notification ---
# We store the previous notification ID so we can replace it.
NOTIFY_ID_FILE="/tmp/waybar_volume_notify_id"

notify_cmd(){
    local human vol summary prev_id new_id

    human="$(get_volume)"
    if [[ "$human" == "muted" ]]; then
        vol=0
        summary="ðŸ”‡ Muted"
    else
        vol="${human%%%}"          # strip trailing %
        summary="ðŸ”Š Volume: $human"
    fi

    # Read previous ID if present (for replacement)
    if [[ -f "$NOTIFY_ID_FILE" ]]; then
        prev_id="$(cat "$NOTIFY_ID_FILE")"
    fi

    # -p / --print-id prints the ID so we can reuse it next time.
    if [[ -n "$prev_id" ]]; then
        new_id="$(notify-send -a "waybar-volume" -p \
                 --hint "int:value:$vol" \
                 --replace-id "$prev_id" \
                 "$summary")"
    else
        new_id="$(notify-send -a "waybar-volume" -p \
                 --hint "int:value:$vol" \
                 "$summary")"
    fi

    # Persist ID for next time
    echo "$new_id" > "$NOTIFY_ID_FILE"
}

case "$1" in
    --up)     volume_up;    notify_cmd ;;
    --down)   volume_down;  notify_cmd ;;
    --toggle) toggle_mute;  notify_cmd ;;
esac
